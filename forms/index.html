<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>vscpl2drv-logger</title>
    
    <!-- Bootstrap -->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/css/bootstrap.min.css">

    <!-- Application settings -->
    <script type="text/javascript" src="js/settings.js"></script>
    
    <!-- Favorite icon -->
    <link rel="icon" href="images/favicon.ico">
    
    <script type="text/javascript">
      var bConnected = false;
    </script>
</head>
<body>

    <div class="modal fade" id="mqtt_settings_dialog" tabindex="-1" role="dialog" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="settingsModalLabel">MQTT host settings</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" id="frmSetting" action="./index.html">
                    <div class="form-group">
                      <label class="control-label col-sm-4 text-primary" for="host">MQTT Host:</label>
                      <div class="col-sm-8">
                        <input type="text" class="form-control" id="mqtt_host" value="127.1.1.1" placeholder="Enter MQTT host">
                      </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-8 text-primary" for="port">MQTT websocket port:</label>
                        <div class="col-sm-8">
                          <input type="number" class="form-control" id="mqtt_port" value="9001" placeholder="Enter MQTT websocket port">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-4 text-primary" for="user">User:</label>
                        <div class="col-sm-8">
                          <input type="text" class="form-control" id="mqtt_username" placeholder="Enter username">
                        </div>
                    </div>
                    <div class="form-group">
                      <label class="control-label col-sm-4 text-primary" for="pwd">Password:</label>
                      <div class="col-sm-8">
                        <input type="password" class="form-control" id="mqtt_password" placeholder="Enter password">
                      </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-4 text-primary" for="clientid">Client id:</label>
                        <div class="col-sm-8">
                          <input type="text" class="form-control" id="mqtt_clientid" value = "vscp-logger-client" placeholder="Enter client id">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-4 text-primary" for="subscribe">Subscribe topic:</label>
                        <div class="col-sm-12">
                          <input type="text" class="form-control" id="mqtt_subscribe" value = "vscp/{{guid}}/#" placeholder="Enter subscription topic">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-4 text-primary" for="mqtt_publish">Publish topic:</label>
                        <div class="col-sm-12">
                          <input type="text" class="form-control" id="mqtt_publish" value="vscp/{{guid}}" placeholder="Enter publish topic">
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="button"  onclick="transferMQTTSettings()" class="btn btn-primary">Save</button>
                    </div>

                </form>
            </div>
            </div>    
        </div>
    </div>

    <div class="container">
      <hr>  
    </div>

    <div class="container">
      <div class="btn-group-justified">
          <button type="button" class="btn btn-primary" data-toggle="modal" id="btnSettings" onclick="showMQTTSettings()" >Settings</button>
          <button type="button" class="btn btn-primary" data-toggle="modal" id="btnConnect" onclick="doConnect()">Connect</button>
          <button type="button" class="btn btn-primary" data-toggle="modal" id="btnConnect" onclick="doDisconnect()">Disconnect</button>
          <label class="control-label col-sm-8 text-info" id="status_text">Unconnected</label>
      </div>
    </div>

    <div class="container">
      <hr>  
    </div>

    <div class="container">
      <h2>vscpl2drv-logger HLO</h2>
      <form class="form-horizontal" id="frmSettings" action="">

        <div class="form-group">
          <b><label class="control-label col-sm-2 text-primary" for="guid">GUID for driver:</label></b>
          <div class="col-sm-10">
            <input type="text" class="form-control" id="frmSettingsDriverGuid" placeholder="Enter GUID" name="guid">
          </div>
        </div>

        <div class="form-group"> 
          <b><label class="control-label col-sm-2 text-primary" for="fmt">Options:</label></b>
          <div class="control-checkbox col-sm-offset-2 col-sm-10 text-secondary">            
            <b><label class="checkbox-inline text-secondary"><input type="checkbox" id="frmSettingsDebug" name="optcheckbox" value="true"> Debug </label></b>
            <b><label class="checkbox-inline text-secondary"><input type="checkbox" id="frmSettingsOverwrite" name="optcheckbox" value="true"> Overwrite </label></b>
          </div>
        </div>

        <div class="form-group"> 
          <b><label class="control-label col-sm-2 text-primary" for="fmt">Log file format:</label></b>
          <div class="radio col-sm-offset-2 col-sm-10">            
            <b><label class="radio-inline text-secondary"><input type="radio" id="frmSettingsOptString" name="optradio" value="str"> String</label></b>
            <b><label class="radio-inline text-secondary"><input type="radio" id="frmSettingsOptXml" name="optradio" value="xml"> XML</label></b>
            <b><label class="radio-inline text-secondary"><input type="radio" id="frmSettingsOptJson" name="optradio" value="json"> JSON</label></b>            
          </div>
        </div>

        <div class="form-group">
          <b><label class="control-label col-sm-2 text-primary" for="path">Path to log file:</label></b>
          <div class="col-sm-10">
            <input type="path" class="form-control" id="frmSettingsPath" placeholder="Enter path" name="path">
          </div>
        </div>
        
        <div class="form-group">
          <b><label class="control-label col-sm-2 text-primary" for="filter">Filter:</label></b>
          <div class="col-sm-10">          
            <input type="filter" class="form-control" id="frmSettingsFilter" placeholder="priority,class,type,guid" name="filter">
          </div>
        </div>
        
        <div class="form-group">
          <b><label class="control-label col-sm-2 text-primary" for="mask">Mask:</label></b>
          <div class="col-sm-10">          
            <input type="mask" class="form-control" id="frmSettingsMask" placeholder="priority,class,type,guid" name="mask">
          </div>
        </div>        
        
        <div class="btn-group-justified">
          <button type="button" class="btn btn-secondary" data-toggle="modal" id="btnNoop" onclick="doNOOP()">NOOP</button>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <button type="button" class="btn btn-success" data-toggle="modal" id="btnReadSettings" onclick="doReadSettings()">Read</button>
          <button type="button" class="btn btn-success" data-toggle="modal" id="btnWriteSettings" onclick="doWriteSettings()">Write</button>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <button type="button" class="btn btn-warning" data-toggle="modal" id="btnWriteSettings" onclick="doStart()">Start</button>
          <button type="button" class="btn btn-warning" data-toggle="modal" id="btnWriteSettings" onclick="doStop()">Stop</button>
          <button type="button" class="btn btn-warning" data-toggle="modal" id="btnWriteSettings" onclick="doRestart()">Restart</button>          
        </div>

      </form>
    </div>

    <!--------------------------------------------------------------------------------------------------------------------->


    <!-- JQuery -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Bootstrap -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/js/bootstrap.min.js"></script>

    <!-- crypto-js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js" integrity="sha512-nOQuvD9nKirvxDdvQ9OMqe2dgapbPB7vYAMrzJihw5m+aNcf0dX53m6YxM4LgA9u8e9eg9QX+/+mPu8kCNpV2A==" crossorigin="anonymous"></script>

    <!-- Tabulator -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/4.9.2/js/tabulator.min.js"></script>

    <!-- VSCP UX version -->    
    <script type="text/javascript" src="js/vscp.js"></script>
    <script type="text/javascript" src="js/vscp_class.js"></script>
    <script type="text/javascript" src="js/vscp_type.js"></script>
    
    <!-- MQTT websocket support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

    <script type="text/javascript">

        var settings = {};
        settings.debug = false;
        settings.overwrite = true;
        settings.format = 2;  // 0=string, 1=XML, 2=JSON
        settings.path = "/tmp/vscpl2drv_logger.log";
        settings.filter = "0,0x0000,0x0000,00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00";
        settings.mask = "0,0x0000,0x0000,00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00";
        // This is the GUID for the driver
        settings.driver_guid = "FF:FF:FF:FF:FF:FF:FF:F5:02:00:00:00:00:00:00:01";

        //document.getElementById("frmSetting").onclick = function() {transferMQTTSettings()};

        //alert(navigator.userAgent);
        
        // --------------------------------------------------------------------
        function transfer_settings() {

          // Debug
          if (settings.debug === true) {
            $('#frmSettingsDebug').prop('checked', true);
          } else {
            $('#frmSettingsDebug').prop('checked', false);
          }

          // Overwrite
          if (settings.debug === true) {
            $('#frmSettingsDebug').prop('checked', true);
          } else {
            $('#frmSettingsDebug').prop('checked', false);
          }

          // Log file format
          if (settings.format === 0) {
            $('#frmSettingsOptString').prop('checked', true);
          } else if (settings.format === 1) {
            $('#frmSettingsOptXml').prop('checked', true);
          } else if (settings.format === 2) {
            $('#frmSettingsOptJson').prop('checked', true);
          }
          else {
            // If invalid format...
            $('#frmSettingsOptString').prop('checked', true);
          }

          // Path where logfile should be written
          $('#frmSettingsPath').prop('value', settings.path);

          // Filter
          $('#frmSettingsFilter').prop('value', settings.filter);

          // Mask
          $('#frmSettingsMask').prop('value', settings.mask);

          // Driver GUID
          $('#frmSettingsDriverGuid').prop('value', settings.driver_guid);
        };

        transfer_settings();

        // --------------------------------------------------------------------
        function showMQTTSettings() {
          $('#mqtt_host').prop('value', mqtt.host);
          $('#mqtt_port').prop('value', mqtt.port);
          $('#mqtt_username').prop('value', mqtt.username);
          $('#mqtt_password').prop('value', mqtt.password);
          $('#mqtt_clientid').prop('value', mqtt.clientid);
          $('#mqtt_subscribe').prop('value', mqtt.subscribe);
          $('#mqtt_publish').prop('value', mqtt.publish);
          $('#mqtt_settings_dialog').modal('show');
        }

        // --------------------------------------------------------------------
        function transferMQTTSettings() {
          //mqtt.host = document.getElementById("mqtt_host").value;
          mqtt.host = $('#mqtt_host').val();
          mqtt.port = Number($('#mqtt_port').val());
          mqtt.username = $('#mqtt_username').val();
          mqtt.password = $('#mqtt_password').val();
          mqtt.clientid = $('#mqtt_clientid').val();
          mqtt.subscribe = $('#mqtt_subscribe').val();
          mqtt.publish = $('#mqtt_publish').val();
          $('#mqtt_settings_dialog').modal('hide');
        }

        // --------------------------------------------------------------------
        function doConnect() {
          // Create a client instance
          console.log("Connecting to " + mqtt.host + ":" + mqtt.port + " - " + mqtt.clientid);
          mqtt.client = new Paho.MQTT.Client(mqtt.host, Number(mqtt.port), mqtt.clientid);
        
          // set callback handlers
          mqtt.client.onConnectionLost = onConnectionLost;
          mqtt.client.onMessageArrived = onMessageArrived;

          // connect the client
          mqtt.client.connect({
                userName: mqtt.username, 
                password: mqtt.password,
                timeout: mqtt.timeout,
                keepAliveInterval: mqtt.keepalive,
                cleanSession: mqtt.cleansession,
                onSuccess: onConnect,
                onFailure: onFailure
          });
        };

        // --------------------------------------------------------------------
        function doDisconnect() {
          mqtt.client.disconnect();
        };

        // --------------------------------------------------------------------
        function doNOOP() {

          if (!bConnected) {
            alert("Must be connected to MQTT broker to send NOOP HLO command.");
            return;
          }

          e = new Event();
          
          e.setDumbNode();  // We are a dumb node
          e.vscpGuid = mqtt.ourguid;
          e.vscpClass = vscp_class.VSCP_CLASS2_HLO;
          e.vscpType = vscp_type.VSCP2_TYPE_HLO_COMMAND;

          // Build the command
          hlo = {};
          hlo.op = "noop";
          hlo.arg = [];
          
          // Set destination GUID
          let GUID = $('#frmSettingsDriverGuid').val().split(":");
          let i = 0;
          GUID.forEach(item => e.vscpData[i++] = parseInt(item, 16));

          // Set HLO type and encryption byte
          e.vscpData[16] = hloDataCoding.VSCP_HLO_TYPE_JSON << 4 + hloEncryption.VSCP_HLO_ENCRYPTION_NONE;

          // Encode HLO in BASE64
          cmdobj = btoa(JSON.stringify(hlo));
          
          var key = CryptoJS.enc.Hex.parse("118936609611995527558842825295939984461619945582983118632182081617810553435620990616930024788597679705273571258581579903462073466509789082074820127722129686153760294141231208449441162740545275340109522272224485137416896122648620761496782965425126716708885036660376323772729833976739164684426895301380869961609075296289916833284295072665793438611150527545219776386070900159530214438516663444085776810");
          //var iv = CryptoJS.enc.Hex.parse("101112131415161718191a1b1c1d1e1f");
          var iv = CryptoJS.lib.WordArray.random(128/8);
          console.log(key.toString());
          var encrypted = CryptoJS.AES.encrypt("Hello world", key, {iv:iv});
          console.log("key: " + encrypted.key.toString());
          console.log(encrypted.ciphertext.toString());
          var decrypted = CryptoJS.AES.decrypt(encrypted.toString(), key, {iv:iv});
          console.log(decrypted.toString(CryptoJS.enc.Utf8));

          let arr = cmdobj.split('');

          e.vscpData = e.vscpData.concat(arr);

          message = new Paho.MQTT.Message(JSON.stringify(e.toJSONObj()));
          message.destinationName = mqtt.publish;
          mqtt.client.send(message);

          
        };

        // --------------------------------------------------------------------
        function doReadSettings() {
          alert("Read Settings");
          alert(mqtt.host);
        };

        // --------------------------------------------------------------------
        function doWriteSettings() {
          alert("Write Settings");
          var frm = $('#frmSettings').serializeArray();
          console.log(frm);
        };

        
        // --------------------------------------------------------------------
        // called when the client connects
        function onConnect() {
            bConnected = true;

            console.log("Connected to remote MQTT host.");
            $("#status_text").text("Connected to remote MQTT host ");
            $("#status_text").append(mqtt.host);
            $("#status_text").append(":");
            $("#status_text").append(mqtt.port);
            
            mqtt.client.subscribe(mqtt.subscribe);

            message = new Paho.MQTT.Message("Hello");
            message.destinationName = mqtt.publish;
            mqtt.client.send(message);
        }

        // --------------------------------------------------------------------
        function onFailure(message) {
          console.log("Connection attempt to host " + mqtt.host + ":" + mqtt.port + " failed.");
          $("#status_text").text("Connection attempt to host " + mqtt.host + ":" + mqtt.port + " failed.");
        }
        
        // --------------------------------------------------------------------
        // called when the client loses its connection
        function onConnectionLost(responseObject) {
            bConnected = false;
            if (responseObject.errorCode !== 0) {
                console.log("onConnectionLost:"+responseObject.errorMessage);
            }
            $("#status_text").text("Disconnected");
        }
        
        // --------------------------------------------------------------------
        // called when a message arrives
        function onMessageArrived(message) {
            console.log("onMessageArrived:"+message.payloadString);
        }
    </script>
    
</body>

</html>
